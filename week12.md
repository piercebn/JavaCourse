# 第十二周作业

## 作业题目

**1.（必做）**配置 redis 的主从复制，sentinel 高可用，Cluster 集群。

**6.（必做）**搭建 ActiveMQ 服务，基于 JMS，写代码分别实现对于 queue 和 topic 的消息生产和消费，代码提交到 github。

## 作业完成说明

### 作业1

> 配置 redis 的主从复制，sentinel 高可用，Cluster 集群
>
> 1.redis 的主从复制
>
> ```
> 1.配置文件
> https://github.com/piercebn/JavaCourse/tree/main/08cache/conf/redis6379.conf
> https://github.com/piercebn/JavaCourse/tree/main/08cache/conf/redis6380.conf
> 
> 2.启动
> redis-server redis6379.conf 
> redis-server redis6380.conf 
> 
> 3.登录
> redis-cli // 默认登录端口6379
> redis-cli -p 6380
> 
> 4.检查数据
> keys * // 初始数据为空
> 
> 5.查看角色
> info // role:master 默认都是主库
> 
> 6.分别设置数据
> set port 6379 // 端口6379实例
> set port 6380 // 端口6380实例
> 
> 7.把6380作为6379的从库
> slaveof 127.0.0.1 6379 //使用回环地址
> 
> 8.查看6380实例中的port数据，和角色
> get port // 数值变为”6379"，因为设为从库后，会把主库的数据同步给自己，覆盖本地原始数据
> info // role:slave 角色变为slave从库， master_host:127.0.0.1 master_port:6379 主库为6379
> set port xxx // (error) READONLY You can't write against a read only replica. 再次设置port值被拒绝，从库为只读模式
> 
> 9.在6379实例中设置数据，在6380实例中自动同步数据
> set year 2021
> 
> 10.观察6379和6380实例日志
> 
> 6379
> 30945:M 31 Oct 2021 23:21:34.825 * Replica 127.0.0.1:6380 asks for synchronization
> 30945:M 31 Oct 2021 23:21:34.825 * Partial resynchronization not accepted: Replication ID mismatch (Replica asked for '452d027a56bf8d8b9319f0a590035ac705258e7e', my replication IDs are '0c269bd0e0c336a71897b9a2a79a9cf38971e94f' and '0000000000000000000000000000000000000000')
> 30945:M 31 Oct 2021 23:21:34.825 * Replication backlog created, my new replication IDs are '1c1465d935d477b8582b86d7e8fd711dff614bd3' and '0000000000000000000000000000000000000000'
> 30945:M 31 Oct 2021 23:21:34.825 * Starting BGSAVE for SYNC with target: disk
> 30945:M 31 Oct 2021 23:21:34.827 * Background saving started by pid 31146
> 31146:C 31 Oct 2021 23:21:34.830 * DB saved on disk
> 30945:M 31 Oct 2021 23:21:34.854 * Background saving terminated with success
> 30945:M 31 Oct 2021 23:21:34.854 * Synchronization with replica 127.0.0.1:6380 succeeded
> 
> 6380
> 30947:S 31 Oct 2021 23:21:34.823 * Before turning into a replica, using my own master parameters to synthesize a cached master: I may be able to synchronize with the new master with just a partial transfer.
> 30947:S 31 Oct 2021 23:21:34.823 * Connecting to MASTER 127.0.0.1:6379
> 30947:S 31 Oct 2021 23:21:34.823 * MASTER <-> REPLICA sync started
> 30947:S 31 Oct 2021 23:21:34.824 * REPLICAOF 127.0.0.1:6379 enabled (user request from 'id=3 addr=127.0.0.1:54211 laddr=127.0.0.1:6380 fd=8 name= age=462 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=42 qbuf-free=45008 argv-mem=20 obl=0 oll=0 omem=0 tot-mem=62516 events=r cmd=slaveof user=default redir=-1')
> 30947:S 31 Oct 2021 23:21:34.824 * Non blocking connect for SYNC fired the event.
> 30947:S 31 Oct 2021 23:21:34.825 * Master replied to PING, replication can continue...
> 30947:S 31 Oct 2021 23:21:34.825 * Trying a partial resynchronization (request 452d027a56bf8d8b9319f0a590035ac705258e7e:1).
> 30947:S 31 Oct 2021 23:21:34.827 * Full resync from master: 1c1465d935d477b8582b86d7e8fd711dff614bd3:0
> 30947:S 31 Oct 2021 23:21:34.827 * Discarding previously cached master state.
> 30947:S 31 Oct 2021 23:21:34.854 * MASTER <-> REPLICA sync: receiving 189 bytes from master to disk
> 30947:S 31 Oct 2021 23:21:34.855 * MASTER <-> REPLICA sync: Flushing old data
> 30947:S 31 Oct 2021 23:21:34.855 * MASTER <-> REPLICA sync: Loading DB in memory
> 30947:S 31 Oct 2021 23:21:34.857 * Loading RDB produced by version 6.2.5
> 30947:S 31 Oct 2021 23:21:34.857 * RDB age 0 seconds
> 30947:S 31 Oct 2021 23:21:34.857 * RDB memory usage when created 2.09 Mb
> 30947:S 31 Oct 2021 23:21:34.857 * MASTER <-> REPLICA sync: Finished with success
> 
> 30947:S 31 Oct 2021 23:22:43.081 * 1 changes in 900 seconds. Saving...
> 30947:S 31 Oct 2021 23:22:43.082 * Background saving started by pid 31169
> 31169:C 31 Oct 2021 23:22:43.084 * DB saved on disk
> 30947:S 31 Oct 2021 23:22:43.187 * Background saving terminated with success
> ```
>
> 2.sentinel 高可用
>
> ```
> 基于上面的主从Redis配置sentinel高可用
> 
> 1.sentinel配置
> https://github.com/piercebn/JavaCourse/tree/main/08cache/conf/sentinel0.conf
> https://github.com/piercebn/JavaCourse/tree/main/08cache/conf/sentinel1.conf
> 
> //实际配置如下，删除选举自动生成信息
> sentinel myid 8d992c54df8f8677b0b345825f61fb733c73d14c
> sentinel deny-scripts-reconfig yes
> sentinel monitor mymaster 127.0.0.1 6379 2 //master节点为6379
> sentinel down-after-milliseconds mymaster 10000
> # Generated by CONFIG REWRITE
> protected-mode no
> port 26379
> user default on nopass sanitize-payload ~* &* +@all
> dir "/Users/yiche1/work/gitworks/JavaCourse/08cache/conf”
> 
> //主节点failover重新选主后，配置文件会自动改变和生成信息
> sentinel myid 8d992c54df8f8677b0b345825f61fb733c73d14c
> sentinel deny-scripts-reconfig yes
> sentinel monitor mymaster 127.0.0.1 6380 2 //master节点改为6380
> sentinel down-after-milliseconds mymaster 10000
> # Generated by CONFIG REWRITE
> protected-mode no
> port 26379
> user default on nopass sanitize-payload ~* &* +@all
> dir "/Users/yiche1/work/gitworks/JavaCourse/08cache/conf"
> //如下为自动生成的选主信息
> sentinel config-epoch mymaster 1
> sentinel leader-epoch mymaster 1
> sentinel known-replica mymaster 127.0.0.1 6379
> sentinel current-epoch 1
> sentinel known-sentinel mymaster 127.0.0.1 26380 8d992c54df8f8677b0b345825f61fb733c73d14d
> 
> 2.启动两个sentinel
> redis-sentinel sentinel0.conf 
> redis-sentinel sentinel1.conf 
> 
> 32075:X 01 Nov 2021 00:24:20.942 # Sentinel ID is 8d992c54df8f8677b0b345825f61fb733c73d14c
> 32075:X 01 Nov 2021 00:24:20.942 # +monitor master mymaster 127.0.0.1 6379 quorum 2
> 32075:X 01 Nov 2021 00:24:20.945 * +slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379
> 32075:X 01 Nov 2021 00:24:46.997 * +sentinel sentinel 8d992c54df8f8677b0b345825f61fb733c73d14d 127.0.0.1 26380 @ mymaster 127.0.0.1 6379
> 
> 3.停掉6379（ctrl+c）
> 30945:M 01 Nov 2021 00:27:27.012 # User requested shutdown...
> 30945:M 01 Nov 2021 00:27:27.012 * Saving the final RDB snapshot before exiting.
> 30945:M 01 Nov 2021 00:27:27.019 * DB saved on disk
> 30945:M 01 Nov 2021 00:27:27.019 * Removing the pid file.
> 30945:M 01 Nov 2021 00:27:27.020 # Redis is now ready to exit, bye bye...
> 
> 4.6380自动切换成master
> 30947:S 01 Nov 2021 00:27:27.025 # Connection with master lost.
> 30947:S 01 Nov 2021 00:27:27.026 * Caching the disconnected master state.
> 30947:S 01 Nov 2021 00:27:27.026 * Reconnecting to MASTER 127.0.0.1:6379
> 30947:S 01 Nov 2021 00:27:27.026 * MASTER <-> REPLICA sync started
> 30947:S 01 Nov 2021 00:27:27.026 # Error condition on socket for SYNC: Connection refused
> 30947:S 01 Nov 2021 00:27:27.519 * Connecting to MASTER 127.0.0.1:6379
> 30947:S 01 Nov 2021 00:27:27.519 * MASTER <-> REPLICA sync started
> 30947:S 01 Nov 2021 00:27:27.519 # Error condition on socket for SYNC: Connection refused
> 30947:S 01 Nov 2021 00:27:28.546 * Connecting to MASTER 127.0.0.1:6379
> 30947:S 01 Nov 2021 00:27:28.547 * MASTER <-> REPLICA sync started
> 30947:S 01 Nov 2021 00:27:28.547 # Error condition on socket for SYNC: Connection refused
> 30947:S 01 Nov 2021 00:27:29.574 * Connecting to MASTER 127.0.0.1:6379
> 30947:S 01 Nov 2021 00:27:29.574 * MASTER <-> REPLICA sync started
> 30947:S 01 Nov 2021 00:27:29.574 # Error condition on socket for SYNC: Connection refused
> 30947:S 01 Nov 2021 00:27:30.599 * Connecting to MASTER 127.0.0.1:6379
> 30947:S 01 Nov 2021 00:27:30.599 * MASTER <-> REPLICA sync started
> 30947:S 01 Nov 2021 00:27:30.599 # Error condition on socket for SYNC: Connection refused
> 30947:S 01 Nov 2021 00:27:31.629 * Connecting to MASTER 127.0.0.1:6379
> 30947:S 01 Nov 2021 00:27:31.629 * MASTER <-> REPLICA sync started
> 30947:S 01 Nov 2021 00:27:31.629 # Error condition on socket for SYNC: Connection refused
> 30947:S 01 Nov 2021 00:27:32.660 * Connecting to MASTER 127.0.0.1:6379
> 30947:S 01 Nov 2021 00:27:32.660 * MASTER <-> REPLICA sync started
> 30947:S 01 Nov 2021 00:27:32.660 # Error condition on socket for SYNC: Connection refused
> 30947:S 01 Nov 2021 00:27:33.683 * Connecting to MASTER 127.0.0.1:6379
> 30947:S 01 Nov 2021 00:27:33.683 * MASTER <-> REPLICA sync started
> 30947:S 01 Nov 2021 00:27:33.683 # Error condition on socket for SYNC: Connection refused
> 30947:S 01 Nov 2021 00:27:34.712 * Connecting to MASTER 127.0.0.1:6379
> 30947:S 01 Nov 2021 00:27:34.713 * MASTER <-> REPLICA sync started
> 30947:S 01 Nov 2021 00:27:34.713 # Error condition on socket for SYNC: Connection refused
> 30947:S 01 Nov 2021 00:27:35.737 * Connecting to MASTER 127.0.0.1:6379
> 30947:S 01 Nov 2021 00:27:35.738 * MASTER <-> REPLICA sync started
> 30947:S 01 Nov 2021 00:27:35.738 # Error condition on socket for SYNC: Connection refused
> 30947:S 01 Nov 2021 00:27:36.763 * Connecting to MASTER 127.0.0.1:6379
> 30947:S 01 Nov 2021 00:27:36.763 * MASTER <-> REPLICA sync started
> 30947:S 01 Nov 2021 00:27:36.763 # Error condition on socket for SYNC: Connection refused
> 30947:M 01 Nov 2021 00:27:37.480 * Discarding previously cached master state.
> 30947:M 01 Nov 2021 00:27:37.480 # Setting secondary replication ID to 1c1465d935d477b8582b86d7e8fd711dff614bd3, valid up to offset: 28147. New replication ID is fe5b5c02a423a959d456cc1d3caa7d6e162cbefc
> 30947:M 01 Nov 2021 00:27:37.481 * MASTER MODE enabled (user request from 'id=8 addr=127.0.0.1:55689 laddr=127.0.0.1:6380 fd=12 name=sentinel-8d992c54-cmd age=173 idle=0 flags=x db=0 sub=0 psub=0 multi=4 qbuf=188 qbuf-free=44862 argv-mem=4 obl=45 oll=0 omem=0 tot-mem=62500 events=r cmd=exec user=default redir=-1')
> 30947:M 01 Nov 2021 00:27:37.495 # CONFIG REWRITE executed with success.
> 
> 5.查看6380信息
> info // role:master connected_slaves:0 6380变为主库
> set a 1 // 设置数据成功
> 
> 6.查看sentinel日志
> 32075:X 01 Nov 2021 00:27:37.107 # +sdown master mymaster 127.0.0.1 6379
> 32075:X 01 Nov 2021 00:27:37.262 # +new-epoch 1
> 32075:X 01 Nov 2021 00:27:37.263 # +vote-for-leader 8d992c54df8f8677b0b345825f61fb733c73d14d 1
> 32075:X 01 Nov 2021 00:27:37.984 # +config-update-from sentinel 8d992c54df8f8677b0b345825f61fb733c73d14d 127.0.0.1 26380 @ mymaster 127.0.0.1 6379
> 32075:X 01 Nov 2021 00:27:37.984 # +switch-master mymaster 127.0.0.1 6379 127.0.0.1 6380
> 32075:X 01 Nov 2021 00:27:37.984 * +slave slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6380
> 32075:X 01 Nov 2021 00:27:48.070 # +sdown slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6380
> 
> 7.重新启动6379，启动后被sentinel自动变为从库，然后链接主库并从主库同步信息
> redis-server redis6379.conf
> 
> 32293:M 01 Nov 2021 00:38:13.106 # Server initialized
> 32293:M 01 Nov 2021 00:38:13.106 * Loading RDB produced by version 6.2.5
> 32293:M 01 Nov 2021 00:38:13.106 * RDB age 646 seconds
> 32293:M 01 Nov 2021 00:38:13.106 * RDB memory usage when created 2.12 Mb
> 32293:M 01 Nov 2021 00:38:13.106 * DB loaded from disk: 0.001 seconds
> 32293:M 01 Nov 2021 00:38:13.106 * Ready to accept connections
> 32293:S 01 Nov 2021 00:38:23.320 * Before turning into a replica, using my own master parameters to synthesize a cached master: I may be able to synchronize with the new master with just a partial transfer.
> 32293:S 01 Nov 2021 00:38:23.320 * Connecting to MASTER 127.0.0.1:6380
> 32293:S 01 Nov 2021 00:38:23.321 * MASTER <-> REPLICA sync started
> 32293:S 01 Nov 2021 00:38:23.321 * REPLICAOF 127.0.0.1:6380 enabled (user request from 'id=3 addr=127.0.0.1:58518 laddr=127.0.0.1:6379 fd=8 name=sentinel-8d992c54-cmd age=10 idle=0 flags=x db=0 sub=0 psub=0 multi=4 qbuf=196 qbuf-free=44854 argv-mem=4 obl=45 oll=0 omem=0 tot-mem=62500 events=r cmd=exec user=default redir=-1')
> 32293:S 01 Nov 2021 00:38:23.329 # CONFIG REWRITE executed with success.
> 32293:S 01 Nov 2021 00:38:23.329 * Non blocking connect for SYNC fired the event.
> 32293:S 01 Nov 2021 00:38:23.329 * Master replied to PING, replication can continue...
> 32293:S 01 Nov 2021 00:38:23.330 * Trying a partial resynchronization (request 9330fbf322b86c59e0294857c8a980acad5ca2a7:1).
> 32293:S 01 Nov 2021 00:38:23.331 * Full resync from master: fe5b5c02a423a959d456cc1d3caa7d6e162cbefc:112385
> 32293:S 01 Nov 2021 00:38:23.331 * Discarding previously cached master state.
> 32293:S 01 Nov 2021 00:38:23.344 * MASTER <-> REPLICA sync: receiving 222 bytes from master to disk
> 32293:S 01 Nov 2021 00:38:23.344 * MASTER <-> REPLICA sync: Flushing old data
> 32293:S 01 Nov 2021 00:38:23.344 * MASTER <-> REPLICA sync: Loading DB in memory
> 32293:S 01 Nov 2021 00:38:23.345 * Loading RDB produced by version 6.2.5
> 32293:S 01 Nov 2021 00:38:23.345 * RDB age 0 seconds
> 32293:S 01 Nov 2021 00:38:23.345 * RDB memory usage when created 2.20 Mb
> 32293:S 01 Nov 2021 00:38:23.345 * MASTER <-> REPLICA sync: Finished with success
> 
> 8.查看sentinel日志，自动将6379变为从库
> 32075:X 01 Nov 2021 00:38:13.365 # -sdown slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6380
> 32075:X 01 Nov 2021 00:38:23.320 * +convert-to-slave slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6380
> 
> 9.查看6379信息
> info // role:slave master_host:127.0.0.1 master_port:6380 变为从库，其主库为6380
> get a // “1” 数据已同步
> set aa 11 // (error) READONLY You can't write against a read only replica. 只读
> 
> 10.在6380里写数据会自动同步到6379
> set aaa 111 // OK 6380里
> get aaa // “111” 6379里
> 
> 11.我们可以将sentinel作为redis server直接连接并查看其信息
> redis-cli -p 26380
> info // 可以查看sentinel信息和master和slaves信息
> 展示信息如下
> sentinel_masters:1
> sentinel_tilt:0
> sentinel_running_scripts:0
> sentinel_scripts_queue_length:0
> sentinel_simulate_failure_flags:0
> master0:name=mymaster,status=ok,address=127.0.0.1:6380,slaves=1,sentinels=2
> ```
>
> 3.Cluster 集群
>
> ```
> 1.配置
> cluster-enabled yes
> 
> 2.创建集群
> # replicas 1 表示集群中的每个主节点创建一个从节点
> redis-cli --cluster create 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 --cluster-replicas 1
> 
> 3.查看集群信息
> # 连接至某个节点
> redis-cli -p 7000
> # 查看集群信息
> 127.0.0.1:7000> cluster info
> # 查看集群节点
> 127.0.0.1:7000> cluster nodes
> 
> 4.Redis操作
> 127.0.0.1:7000> set aaa 111
> (error) MOVED 10439 127.0.0.1:7001
> 127.0.0.1:7000> set bbb 222
> OK
> 127.0.0.1:7000> set ccc 333
> OK
> 127.0.0.1:7000> set ddd 444
> (error) MOVED 11367 127.0.0.1:7002
> 127.0.0.1:7000> get aaa
> (error) MOVED 10439 127.0.0.1:7001
> 127.0.0.1:7000> get bbb
> "222"
> ```



### 作业6

> 搭建 ActiveMQ 服务，基于 JMS，写代码分别实现对于 queue 和 topic 的消息生产和消费
>
> https://github.com/piercebn/JavaCourse/tree/main/09mq/jms-activemq



